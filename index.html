<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Short Video Platform</title>
    <style>
        :root {
            --primary: #0095f6;
            --primary-dark: #0064e0;
            --danger: #ff4444;
            --text-light: rgba(255,255,255,0.9);
            --text-muted: rgba(255,255,255,0.6);
            --bg-dark: #0f0f0f;
            --bg-darker: #050505;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        #app {
            height: 100vh;
            position: relative;
        }

        .timer-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15,15,15,0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timer-display::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .timer-expired {
            color: var(--danger);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }

        .reel-container {
            height: 100vh;
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .reel-container::-webkit-scrollbar {
            display: none;
        }

        .video-item {
            height: 100vh;
            width: 100%;
            scroll-snap-align: start;
            position: relative;
            background-color: var(--bg-dark);
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .video-actions {
            position: absolute;
            right: 16px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 10;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(15,15,15,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .action-btn:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.1);
        }

        .action-icon {
            width: 24px;
            height: 24px;
            transition: all 0.3s ease;
        }

        .action-count {
            position: absolute;
            bottom: -15px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
        }

        .like-btn .action-icon {
            fill: transparent;
            stroke: white;
            stroke-width: 2;
        }

        .like-btn.liked .action-icon {
            fill: #ff1744;
            stroke: #ff1744;
            animation: heartBeat 0.8s;
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }

        .share-btn .action-icon {
            stroke: white;
            stroke-width: 2;
        }

        .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .profile-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .like-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0;
            opacity: 0;
            pointer-events: none;
            color: #ff1744;
            text-shadow: 0 0 20px rgba(255, 23, 68, 0.8);
        }

        .show-like {
            font-size: 80px;
            opacity: 0.8;
            transform: translate(-50%, -50%) scale(1);
            animation: floatUp 1s forwards;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; }
            100% { transform: translate(-50%, -150%) scale(1.2); opacity: 0; }
        }

        .ad-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-darker);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .ad-content {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .ad-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: black;
        }

        .ad-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15,15,15,0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            backdrop-filter: blur(5px);
        }

        .ad-skip {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            display: none;
        }

        .video-blocked {
            filter: blur(5px) brightness(0.7);
        }

        .block-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .block-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--danger);
        }

        .block-subtitle {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 30px;
        }

        .watch-ad-btn {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: loading 1s linear infinite;
        }

        @keyframes loading {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .ad-button {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="timer-display" id="timerDisplay">01:00</div>
        
        <div class="reel-container" id="reelContainer">
            <div class="loading" id="mainLoading"></div>
        </div>
        
        <div class="ad-modal" id="adModal">
            <div class="ad-content">
                <video class="ad-video" id="adVideo"></video>
                <div class="ad-timer" id="adTimer">Ad: 10s</div>
                <button class="ad-skip" id="adSkip" onclick="skipAd()">Skip Ad</button>
                <button class="ad-button" id="customAdButton" onclick="handleAdButtonClick()">Visit Website</button>
            </div>
        </div>
    </div>

    <script>
        // App State
        let freeTimeLeft = 60;
        let timerInterval;
        let currentVideoIndex = 0;
        let videos = [];
        let videoQueue = [];
        let playedVideos = new Set();
        let isAdPlaying = false;
        let adTimeLeft = 10;
        let adInterval;
        let videoData = [];
        let adData = [];
        let currentAd = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            loadVideosFromStorage();
            loadAdsFromStorage();
            startFreeTimer();
            
            // Preload all videos
            setTimeout(preloadVideos, 1000);
        });
        
        // Load videos from localStorage
        function loadVideosFromStorage() {
            const storedVideos = localStorage.getItem('reelAppVideos');
            
            if (!storedVideos || JSON.parse(storedVideos).length === 0) {
                // Default empty state
                videoData = [];
                localStorage.setItem('reelAppVideos', JSON.stringify(videoData));
            } else {
                videoData = JSON.parse(storedVideos);
            }
            
            shuffleVideos();
            createVideoElements();
        }
        
        // Load ads from localStorage
        function loadAdsFromStorage() {
            const storedAds = localStorage.getItem('reelAppAds');
            
            if (!storedAds || JSON.parse(storedAds).length === 0) {
                // Default empty state
                adData = [];
                localStorage.setItem('reelAppAds', JSON.stringify(adData));
            } else {
                adData = JSON.parse(storedAds);
            }
        }
        
        // Preload all videos for smooth playback
        function preloadVideos() {
            videoData.forEach(video => {
                const preloadLink = document.createElement('link');
                preloadLink.rel = 'preload';
                preloadLink.as = 'video';
                preloadLink.href = video.url;
                document.head.appendChild(preloadLink);
            });
        }
        
        // Shuffle videos randomly
        function shuffleVideos() {
            videoQueue = [...videoData];
            for (let i = videoQueue.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [videoQueue[i], videoQueue[j]] = [videoQueue[j], videoQueue[i]];
            }
        }
        
        // Create video elements
        function createVideoElements() {
            const container = document.getElementById('reelContainer');
            const loading = document.getElementById('mainLoading');
            
            if (videoQueue.length === 0) {
                loading.style.display = 'none';
                container.innerHTML = `
                    <div style="display: flex; height: 100%; justify-content: center; align-items: center; color: var(--text-muted);">
                        No videos available. Admin can add videos in the admin panel.
                    </div>
                `;
                return;
            }
            
            loading.style.display = 'none';
            
            videoQueue.forEach((videoInfo, index) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.innerHTML = `
                    <video class="video-player" loop preload="auto" data-video-id="${videoInfo.id}">
                        <source src="${videoInfo.url}" type="video/mp4">
                    </video>
                    <div class="like-animation">❤️</div>
                    <div class="video-actions">
                        <button class="action-btn like-btn" onclick="toggleLike(this, ${videoInfo.id})">
                            <svg class="action-icon" viewBox="0 0 24 24">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                            <span class="action-count">${formatCount(videoInfo.likes)}</span>
                        </button>
                        <button class="action-btn share-btn" onclick="shareVideo(${videoInfo.id})">
                            <svg class="action-icon" viewBox="0 0 24 24">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                                <polyline points="16 6 12 2 8 6"/>
                                <line x1="12" y1="2" x2="12" y2="15"/>
                            </svg>
                        </button>
                        <div class="action-btn profile-btn">
                            <img src="${videoInfo.profilePic}" class="profile-pic" alt="Profile" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZD0iTTEyIDJhMTAgMTAgMCAxIDAgMTAgMTBBMTAgMTAgMCAwIDAgMTIgMnptMCAzYTcgNyAwIDEgMS0xMCAwIDcgNyAwIDAgMSAxMCAwem0wIDlhMiAyIDAgMSAwIDAtNCAyIDIgMCAwIDAgMCA0eiIgZmlsbD0id2hpdGUiLz48L3N2Zz4='">
                        </div>
                    </div>
                `;
                container.appendChild(videoItem);
            });
            
            videos = document.querySelectorAll('.video-player');
            setupVideoEvents();
            
            // Play first video automatically
            if (videos.length > 0) {
                playVideo(videos[0]);
            }
        }
        
        // Setup video events
        function setupVideoEvents() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target;
                    if (entry.isIntersecting && freeTimeLeft > 0) {
                        currentVideoIndex = Array.from(videos).indexOf(video);
                        playVideo(video);
                        markVideoAsPlayed(video.dataset.videoId);
                    } else {
                        video.pause();
                    }
                });
            }, { threshold: 0.8 });
            
            videos.forEach(video => {
                observer.observe(video);
                
                // Click to play/pause
                video.addEventListener('click', function(e) {
                    if (freeTimeLeft > 0) {
                        if (video.paused) {
                            video.play();
                        } else {
                            video.pause();
                        }
                    }
                });
                
                // Double tap to like
                video.addEventListener('dblclick', function(e) {
                    const likeAnim = this.parentElement.querySelector('.like-animation');
                    likeAnim.classList.add('show-like');
                    setTimeout(() => {
                        likeAnim.classList.remove('show-like');
                    }, 1000);
                    
                    const likeBtn = this.parentElement.querySelector('.like-btn');
                    const videoId = this.dataset.videoId;
                    toggleLike(likeBtn, videoId);
                });
            });
        }
        
        // Play video
        function playVideo(video) {
            if (freeTimeLeft <= 0) {
                blockVideo(video);
                return;
            }
            
            videos.forEach(v => {
                if (v !== video) v.pause();
            });
            
            video.muted = false;
            video.play().catch(e => {
                video.muted = true;
                video.play().catch(console.error);
            });
        }
        
        // Block video when time expires
        function blockVideo(video) {
            video.classList.add('video-blocked');
            
            const videoItem = video.parentElement;
            if (!videoItem.querySelector('.block-overlay')) {
                const overlay = document.createElement('div');
                overlay.className = 'block-overlay';
                overlay.innerHTML = `
                    <div class="block-title">Time's Up!</div>
                    <div class="block-subtitle">Watch a short ad to continue browsing</div>
                    <button class="watch-ad-btn" onclick="showAd()">Watch Ad (10s)</button>
                `;
                videoItem.appendChild(overlay);
            }
        }
        
        // Mark video as played
        function markVideoAsPlayed(videoId) {
            playedVideos.add(videoId);
            
            // If all videos played, reshuffle
            if (videoData.length > 0 && playedVideos.size >= videoData.length) {
                playedVideos.clear();
                shuffleVideos();
                const container = document.getElementById('reelContainer');
                container.innerHTML = '<div class="loading" id="mainLoading"></div>';
                createVideoElements();
            }
        }
        
        // Start free timer
        function startFreeTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                freeTimeLeft--;
                
                const minutes = Math.floor(freeTimeLeft / 60);
                const seconds = freeTimeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (freeTimeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = 'TIME UP';
                    timerDisplay.classList.add('timer-expired');
                    
                    if (videos[currentVideoIndex]) {
                        blockVideo(videos[currentVideoIndex]);
                    }
                }
            }, 1000);
        }
        
        // Toggle like on video
        function toggleLike(button, videoId) {
            const icon = button.querySelector('.action-icon');
            const count = button.querySelector('.action-count');
            
            if (button.classList.contains('liked')) {
                button.classList.remove('liked');
                count.textContent = formatCount(parseInt(count.textContent.replace(/[^0-9]/g, '')) - 1);
            } else {
                button.classList.add('liked');
                count.textContent = formatCount(parseInt(count.textContent.replace(/[^0-9]/g, '')) + 1);
            }
            
            // Update in videoData
            const videoIndex = videoData.findIndex(v => v.id == videoId);
            if (videoIndex !== -1) {
                if (button.classList.contains('liked')) {
                    videoData[videoIndex].likes += 1;
                } else {
                    videoData[videoIndex].likes -= 1;
                }
                localStorage.setItem('reelAppVideos', JSON.stringify(videoData));
            }
        }
        
        // Format count (1K, 1M, etc.)
        function formatCount(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // Share video
        function shareVideo(videoId) {
            const video = videoData.find(v => v.id == videoId);
            if (!video) return;
            
            const shareUrl = `${window.location.origin}?video=${videoId}`;
            const shareText = `Check out this video! ${shareUrl}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Share Video',
                    text: 'Check out this video!',
                    url: shareUrl
                }).catch(console.error);
            } else {
                // Fallback for browsers that don't support Web Share API
                const tempInput = document.createElement('input');
                document.body.appendChild(tempInput);
                tempInput.value = shareUrl;
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('Link copied to clipboard: ' + shareUrl);
            }
        }
        
        // Show advertisement
        function showAd() {
            if (adData.length === 0) {
                // If no ads, just grant more time
                freeTimeLeft += 60;
                startFreeTimer();
                document.querySelectorAll('.block-overlay').forEach(el => el.remove());
                document.querySelectorAll('.video-blocked').forEach(el => el.classList.remove('video-blocked'));
                if (videos[currentVideoIndex]) playVideo(videos[currentVideoIndex]);
                return;
            }
            
            // Select random ad
            currentAd = adData[Math.floor(Math.random() * adData.length)];
            
            const adModal = document.getElementById('adModal');
            const adVideo = document.getElementById('adVideo');
            const adTimer = document.getElementById('adTimer');
            const adSkip = document.getElementById('adSkip');
            const customAdButton = document.getElementById('customAdButton');
            
            isAdPlaying = true;
            adTimeLeft = 10;
            adModal.style.display = 'flex';
            
            // Set ad button properties
            if (currentAd.buttonText) {
                customAdButton.textContent = currentAd.buttonText;
            }
            if (currentAd.buttonColor) {
                customAdButton.style.background = currentAd.buttonColor;
            }
            customAdButton.style.display = currentAd.buttonLink ? 'block' : 'none';
            
            // Pause all videos while ad plays
            videos.forEach(v => v.pause());
            
            // Set ad video source
            adVideo.innerHTML = `<source src="${currentAd.url}" type="video/mp4">`;
            adVideo.load();
            adVideo.muted = false;
            adVideo.play();
            
            // Ad timer
            adInterval = setInterval(() => {
                adTimeLeft--;
                adTimer.textContent = `Ad: ${adTimeLeft}s`;
                
                if (adTimeLeft <= 5) {
                    adSkip.style.display = 'block';
                }
                
                if (adTimeLeft <= 0) {
                    skipAd();
                }
            }, 1000);
        }
        
        // Handle custom ad button click
        function handleAdButtonClick() {
            if (currentAd && currentAd.buttonLink) {
                window.open(currentAd.buttonLink, '_blank');
            }
        }
        
        // Skip advertisement
        function skipAd() {
            const adModal = document.getElementById('adModal');
            const adVideo = document.getElementById('adVideo');
            const adSkip = document.getElementById('adSkip');
            
            clearInterval(adInterval);
            adVideo.pause();
            adVideo.currentTime = 0;
            adModal.style.display = 'none';
            adSkip.style.display = 'none';
            isAdPlaying = false;
            
            // Grant more free time
            freeTimeLeft += 60;
            
            // Update timer display
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.classList.remove('timer-expired');
            
            // Remove block overlays
            document.querySelectorAll('.block-overlay').forEach(overlay => {
                overlay.remove();
            });
            
            // Remove video blocks
            document.querySelectorAll('.video-blocked').forEach(video => {
                video.classList.remove('video-blocked');
            });
            
            // Restart timer
            startFreeTimer();
            
            // Resume current video
            if (videos[currentVideoIndex]) {
                playVideo(videos[currentVideoIndex]);
            }
        }
        
        // Listen for storage changes (from admin panel)
        window.addEventListener('storage', function(e) {
            if (e.key === 'reelAppVideos') {
                videoData = JSON.parse(e.newValue);
                playedVideos.clear();
                const container = document.getElementById('reelContainer');
                container.innerHTML = '<div class="loading" id="mainLoading"></div>';
                shuffleVideos();
                createVideoElements();
            }
            if (e.key === 'reelAppAds') {
                adData = JSON.parse(e.newValue);
            }
        });

        // Handle deep linking
        function checkForDeepLink() {
            const params = new URLSearchParams(window.location.search);
            const videoId = params.get('video');
            if (videoId && videoData.length > 0) {
                const videoIndex = videoData.findIndex(v => v.id == videoId);
                if (videoIndex !== -1) {
                    // Scroll to the video
                    setTimeout(() => {
                        if (videos[videoIndex]) {
                            videos[videoIndex].scrollIntoView();
                            playVideo(videos[videoIndex]);
                        }
                    }, 1000);
                }
            }
        }

        // Initial deep link check
        checkForDeepLink();
    </script>
</body>
</html>
